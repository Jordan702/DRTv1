<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AliveAI Chat</title>
<style>
  body { font-family: Arial, sans-serif; background:#121212; color:#fff; margin:0; display:flex; flex-direction:column; height:100vh; }
  header { display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#1e1e1e; border-bottom:1px solid #333; }
  header h1 { margin:0; font-size:1.5em; }
  #status { font-size:0.9em; color:#ffa500; }
  #chat-container { flex:1; overflow-y:auto; padding:20px; background:#1b1b1b; display:flex; flex-direction:column; }
  .message { margin:10px 0; padding:10px 15px; border-radius:10px; max-width:70%; word-break:break-word; }
  .user { background:#0d6efd; align-self:flex-end; }
  .ai { background:#6c757d; align-self:flex-start; }
  .tx-hashes { font-size:0.8em; margin-top:5px; word-break:break-all; color:#e0e0e0; }
  #input-container { display:flex; padding:10px; background:#222; }
  #message { flex:1; padding:10px; border-radius:5px; border:none; }
  button { padding:10px 20px; margin-left:10px; border:none; border-radius:5px; background:#0d6efd; color:#fff; cursor:pointer; }
</style>
</head>
<body>
<header>
  <h1>AliveAI</h1>
  <span id="status">Patent Pending #63/926,449</span>
</header>

<div id="chat-container"></div>

<div id="input-container">
  <input id="message" placeholder="Type your message here..." />
  <button id="sendBtn">Send</button>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const sendBtn = document.getElementById('sendBtn');
const statusEl = document.getElementById('status');

function appendMessage(text, className='ai', txHashes=[]) {
  const msg = document.createElement('div');
  msg.className = `message ${className}`;
  msg.innerHTML = text;
  if (txHashes && txHashes.length) {
    const h = document.createElement('div');
    h.className = 'tx-hashes';
    h.innerHTML = txHashes.map((x,i)=>`Tx${i+1}: ${x}`).join('<br>');
    msg.appendChild(h);
  }
  chatContainer.appendChild(msg);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('message');
  const message = input.value.trim();
  if (!message) return;
  appendMessage(`<b>You:</b> ${message}`, 'user');
  input.value = '';
  statusEl.textContent = 'Pending...';

  try {
    const res = await fetch('/api/aliveAI/runCycle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        stimulus: message,
        cognition: '',
        axis: 'DRTv21',
        amount: 1,
        tokenSwapOut: 'DRTv22'
      })
    });

    // try parse JSON safely; if server returns HTML, show the raw text
    let data;
    const text = await res.text();
    try {
      data = JSON.parse(text);
    } catch (e) {
      // not JSON â€” show the server response raw for debugging
      appendMessage(`<b>AliveAI Error (raw response):</b><pre style="white-space:pre-wrap;color:#f88">${text}</pre>`, 'ai');
      statusEl.textContent = 'Error';
      return;
    }

    if (!data) {
      appendMessage(`<b>AliveAI Error:</b> Empty response`, 'ai');
      statusEl.textContent = 'Error';
      return;
    }

    if (data.success) {
      const { state } = data;
      const txHashes = (state && state.txHashes) || [];
      appendMessage(`<b>AliveAI:</b> ${state.E || ' (no E returned) '}`, 'ai', txHashes);
      statusEl.textContent = 'Idle';
    } else {
      appendMessage(`<b>AliveAI Error:</b> ${data.error || 'Unknown error'}`, 'ai');
      statusEl.textContent = 'Error';
    }
  } catch (err) {
    console.error(err);
    appendMessage(`<b>AliveAI Error:</b> ${err.message}`, 'ai');
    statusEl.textContent = 'Error';
  }
}

sendBtn.addEventListener('click', sendMessage);
document.getElementById('message').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
