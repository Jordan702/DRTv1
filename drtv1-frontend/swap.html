<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DRT Mesh Swap</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 2em;
    }
    h1 { font-size: 2.5em; margin-bottom: 0.2em; }
    p { font-size: 1.1em; margin-bottom: 1em; }

    #wallet-address, #impact-points, #gas-cost {
      margin: 0.5em 0;
      font-size: 0.9em;
      color: #ccc;
    }

    input[type="text"], select {
      padding: 0.5em;
      width: 60%;
      margin-bottom: 1em;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #222;
      color: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #444;
    }
    th {
      background-color: #222;
    }
    tr:hover {
      background-color: #1a1a1a;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 8px;
      color: #fff;
      font-size: 0.8rem;
      margin: 2px;
      display: inline-block;
    }

    .category-Food { background-color: #5c4033; }
    .category-Climate { background-color: #2e8b57; }
    .category-Infrastructure { background-color: #8b0000; }
    .category-Education { background-color: #fff; color: #000; }
    .category-Health { background-color: #4682b4; }
    .category-Multi { background-color: yellow; color: black; }

    .action-btn {
      background-color: #2e7d32;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .action-btn:hover {
      background-color: #388e3c;
    }

    .connect-btn {
      background-color: #444;
      color: white;
      padding: 6px 16px;
      border: none;
      border-radius: 4px;
      margin-bottom: 1em;
      cursor: pointer;
    }

    .legend {
      margin-top: 1em;
      font-size: 0.9em;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>Welcome to DRT Mesh</h1>
  <p>Every buy supports global livelihoods. Earn DRT as impact rewards. 100 points = $1 worth of DRT.</p>

  <button class="connect-btn" onclick="init()">Connect Wallet</button>
  <div id="wallet-address"></div>
  <div id="impact-points">Impact Points: 0</div>
  <div id="gas-cost">Live Gas (Est): ...</div>

  <hr style="margin: 2em 0;">
  <h2>Universal Token Swap</h2>
  <div>
    <select id="token-in"></select>
    <input type="text" id="amount-in" placeholder="Amount In">
    ‚áÖ
    <select id="token-out"></select>
    <input type="text" id="min-out" placeholder="Min Amount Out">
    <div id="estimated-out" style="color: #ccc; margin-bottom: 1em;"></div>
    <button id="multi-swap">Execute Swap</button>
  </div>

  <input type="text" id="search" placeholder="Search tokens...">
  <table>
    <thead>
      <tr>
        <th>Logo</th>
        <th>Token</th>
        <th>Category</th>
        <th>Impact Score</th>
        <th>Price</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="token-list"></tbody>
  </table>

  <div class="legend">
    Categories: Food üçû, Climate üå±, Infrastructure üèó, Education üìö, Health üè• ‚Äî If multiple, badge is yellow üåÄ
  </div>

  <footer style="margin-top: 3em; font-size: 0.9em; color: #aaa;">
    üí° Have a token that supports global livelihoods?  
    <strong>DM me ‚Äî I‚Äôll list it for free.</strong><br><br>
    üì© Email: <a href="mailto:jordanschwartz702@gmail.com" style="color: #6cf;">jordanschwartz702@gmail.com</a><br>
    üí¨ Telegram: <a href="https://t.me/DRTv1Official" target="_blank" style="color: #6cf;">@DRTv1Official</a><br>
    üê¶ Twitter: <a href="https://twitter.com/DRTv1Official" target="_blank" style="color: #6cf;">@DRTv1Official</a>
  </footer>

  <script type="module">
    import { abi as routerAbi } from '../abi/DRTUniversalRouter_abi.json' assert { type: 'json' };

    const routerAddress = "0xd0fdaC020eFDBC4544372EB3260Bb15CE77206Ef";
    let web3, account, router, tokenRegistry, meshPools;

    async function init() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        router = new web3.eth.Contract(routerAbi, routerAddress);
        document.getElementById("wallet-address").textContent = "Connected: " + account;
        updateImpactPoints();
        await loadRegistry();
        await loadMeshPools();
      } else {
        alert("MetaMask not found!");
      }
    }

    async function loadRegistry() {
      const res = await fetch("./tokenRegistry.json");
      tokenRegistry = await res.json();
      const selectIn = document.getElementById("token-in");
      const selectOut = document.getElementById("token-out");
      Object.values(tokenRegistry).forEach(token => {
        selectIn.appendChild(new Option(`${token.name} (${token.ticker})`, token.address));
        selectOut.appendChild(new Option(`${token.name} (${token.ticker})`, token.address));
      });
    }

    async function loadMeshPools() {
      const res = await fetch('./meshPools.json');
      meshPools = await res.json();
    }

    function findPath(tokenIn, tokenOut) {
      const graph = {};
      for (const [pair, { token0, token1 }] of Object.entries(meshPools)) {
        if (!graph[token0]) graph[token0] = [];
        if (!graph[token1]) graph[token1] = [];
        graph[token0].push({ token: token1, pair });
        graph[token1].push({ token: token0, pair });
      }

      const queue = [[tokenIn]];
      const visited = new Set();
      const parent = {};

      while (queue.length > 0) {
        const path = queue.shift();
        const last = path[path.length - 1];
        if (last === tokenOut) break;
        if (visited.has(last)) continue;
        visited.add(last);
        for (const { token, pair } of graph[last] || []) {
          if (!visited.has(token)) {
            parent[token] = { prev: last, pair };
            queue.push([...path, token]);
          }
        }
      }

      if (!parent[tokenOut]) return { path: [], pairs: [] };
      const path = [tokenOut];
      const pairs = [];
      while (path[0] !== tokenIn) {
        const { prev, pair } = parent[path[0]];
        path.unshift(prev);
        pairs.unshift(pair);
      }
      return { path, pairs };
    }

    document.getElementById("multi-swap").addEventListener("click", async () => {
      const tokenIn = document.getElementById("token-in").value;
      const tokenOut = document.getElementById("token-out").value;
      const amountIn = web3.utils.toWei(document.getElementById("amount-in").value, 'ether');
      const minOut = web3.utils.toWei(document.getElementById("min-out").value, 'ether');

      const { path, pairs } = findPath(tokenIn, tokenOut);
      if (!path.length || !pairs.length) return alert("No path found");

      const tokenContract = new web3.eth.Contract([{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"}], tokenIn);
      await tokenContract.methods.approve(routerAddress, amountIn).send({ from: account });

      await router.methods.swapExactTokensForTokens(path, pairs, amountIn).send({ from: account });
      incrementImpactPoints();
      alert("Swap successful");
    });

    document.getElementById("amount-in").addEventListener("input", async () => {
      const tokenIn = document.getElementById("token-in").value;
      const tokenOut = document.getElementById("token-out").value;
      const amountIn = web3.utils.toWei(document.getElementById("amount-in").value || '0', 'ether');

      const { path, pairs } = findPath(tokenIn, tokenOut);
      if (!path.length || !pairs.length) {
        document.getElementById("estimated-out").textContent = "No route found.";
        return;
      }

      const est = await router.methods.estimateMultiHop(path, pairs, amountIn).call();
      document.getElementById("estimated-out").textContent = `Estimated Out: ${web3.utils.fromWei(est)} tokens`;
    });

    function incrementImpactPoints() {
      const key = "impactPoints_" + account;
      let points = parseInt(localStorage.getItem(key) || '0');
      points += 10;
      localStorage.setItem(key, points);
      updateImpactPoints();
    }

    function updateImpactPoints() {
      const key = "impactPoints_" + account;
      const points = parseInt(localStorage.getItem(key) || '0');
      document.getElementById("impact-points").textContent = `Impact Points: ${points}`;
    }
  </script>
</body>
</html>
