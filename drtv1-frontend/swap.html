<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Token Swap</title>
  <!-- Include Ethers.js for interacting with Ethereum -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    #walletInfo {
      text-align: right;
      margin-bottom: 20px;
    }
    #connectButton {
      padding: 6px 12px;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      background: #377dff;
      color: #fff;
      cursor: pointer;
    }
    #connectButton:hover {
      background: #2c6fe3;
    }
    #walletAddress {
      margin-left: 15px;
      font-weight: 500;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .swap-form {
      max-width: 420px;
      margin: 0 auto;
      padding: 20px;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .swap-field {
      margin-bottom: 15px;
    }
    .swap-field label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .input-group {
      display: flex;
      align-items: center;
    }
    .input-group input {
      flex: 1;
      padding: 8px;
      font-size: 16px;
    }
    .input-group select {
      width: 30%;
      margin-left: 10px;
      padding: 8px;
      font-size: 16px;
    }
    #swapButton {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: 600;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #swapButton:disabled {
      background: #95d7a5;
      cursor: not-allowed;
    }
    #errorMessage {
      min-height: 1.5em;
      margin-top: 10px;
      font-weight: 500;
      color: red;
      text-align: center;
    }
    #impactPointsDisplay {
      margin-top: 15px;
      font-weight: 600;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Wallet connection section -->
  <div id="walletInfo">
    <button id="connectButton">Connect Wallet</button>
    <span id="walletAddress"></span>
  </div>
  <h1>Token Swap</h1>
  <!-- Swap interface -->
  <form class="swap-form" onsubmit="return false;">
    <div class="swap-field">
      <label for="fromAmount">From:</label>
      <div class="input-group">
        <input type="number" id="fromAmount" placeholder="0.0" />
        <select id="fromToken"></select>
      </div>
    </div>
    <div class="swap-field">
      <label for="toAmount">To:</label>
      <div class="input-group">
        <input type="number" id="toAmount" placeholder="0.0" disabled />
        <select id="toToken"></select>
      </div>
    </div>
    <button type="button" id="swapButton">Swap</button>
    <div id="errorMessage"></div>
    <div id="impactPointsDisplay">Impact Points: 0</div>
  </form>

  <script>
    // Initialize ethers provider and contract
    let provider, signer, routerContract, currentAccount;
    const routerAddress = "0xd0fdaC020eFDBC4544372EB3260Bb15CE77206Ef";
    // ABI for the UniversalDRTSwapRouter (loaded from external JSON)
    let routerAbi = null;
    // Minimal ERC-20 ABI for approvals
    const erc20Abi = [
      "function approve(address spender, uint256 value) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)"
    ];
    // Token registry list will be loaded from tokenRegistry.json
    let tokens = [];

    // Utility: shorten address for display
    function shortenAddress(addr) {
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    // Populate the From/To token dropdowns with token symbols
    function populateTokenSelects() {
      const fromSelect = document.getElementById("fromToken");
      const toSelect = document.getElementById("toToken");
      fromSelect.innerHTML = "";
      toSelect.innerHTML = "";
      tokens.forEach(token => {
        const opt1 = document.createElement("option");
        opt1.value = token.symbol;
        opt1.textContent = token.symbol;
        const opt2 = opt1.cloneNode(true);
        fromSelect.appendChild(opt1);
        toSelect.appendChild(opt2);
      });
      // Set default selections if available (e.g., ETH -> DRT)
      if (tokens.find(t => t.symbol === "ETH") && tokens.find(t => t.symbol === "DRT")) {
        document.getElementById("fromToken").value = "ETH";
        document.getElementById("toToken").value = "DRT";
      }
    }

    // Connect wallet on "Connect Wallet" button click
    const connectButton = document.getElementById("connectButton");
    const walletAddressSpan = document.getElementById("walletAddress");
    connectButton.addEventListener("click", async () => {
      if (!window.ethereum) {
        alert("No Ethereum wallet detected. Please install MetaMask.");
        return;
      }
      try {
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        currentAccount = await signer.getAddress();
        walletAddressSpan.textContent = shortenAddress(currentAccount);
        // Initialize the router contract with signer
        if (routerAbi) {
          routerContract = new ethers.Contract(routerAddress, routerAbi, signer);
        }
        // Display current impact points for this address
        const pointsKey = "impactPoints_" + currentAccount.toLowerCase();
        const currentPoints = parseInt(localStorage.getItem(pointsKey) || "0");
        document.getElementById("impactPointsDisplay").textContent = "Impact Points: " + currentPoints;
      } catch (err) {
        console.error("Wallet connection failed:", err);
        alert("Failed to connect wallet.");
      }
    });

    // Swap button logic
    const swapButton = document.getElementById("swapButton");
    swapButton.addEventListener("click", async () => {
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.style.color = "red";
      errorDiv.textContent = ""; // clear previous error
      if (!signer || !currentAccount) {
        errorDiv.textContent = "Please connect your wallet first.";
        return;
      }
      const fromSymbol = document.getElementById("fromToken").value;
      const toSymbol = document.getElementById("toToken").value;
      const fromAmountInput = document.getElementById("fromAmount");
      const amountStr = fromAmountInput.value.trim();
      const amountNum = parseFloat(amountStr);
      if (!amountStr || isNaN(amountNum) || amountNum <= 0) {
        errorDiv.textContent = "Enter a valid amount to swap.";
        return;
      }
      // Prevent swapping the same token to itself
      if (fromSymbol === toSymbol) {
        errorDiv.textContent = "Cannot swap the same token.";
        return;
      }
      // Determine if route is supported
      const isDRTtoETH = (fromSymbol === "DRT" && toSymbol === "ETH");
      const isETHtoDRT = (fromSymbol === "ETH" && toSymbol === "DRT");
      if (!isDRTtoETH && !isETHtoDRT) {
        // If either side is ETH but not the DRT pair, it's unsupported by this router
        if (fromSymbol === "ETH" || toSymbol === "ETH") {
          errorDiv.textContent = "This token pair is not supported.";
          return;
        }
      }
      // Prepare contract call parameters
      const fromTokenData = tokens.find(t => t.symbol === fromSymbol);
      const toTokenData = tokens.find(t => t.symbol === toSymbol);
      if (!fromTokenData || !toTokenData) {
        errorDiv.textContent = "Token data not available.";
        return;
      }
      let amountInWei;
      try {
        if (fromSymbol === "ETH") {
          // Parse Ether amount
          amountInWei = ethers.utils.parseEther(amountStr);
        } else {
          // Parse ERC-20 token amount with its decimals
          amountInWei = ethers.utils.parseUnits(amountStr, fromTokenData.decimals);
        }
      } catch (parseErr) {
        errorDiv.textContent = "Invalid amount format.";
        return;
      }
      try {
        swapButton.disabled = true;
        swapButton.textContent = "Swapping...";
        let tx;
        // If input token is an ERC-20 (not ETH), ensure allowance
        if (fromSymbol !== "ETH") {
          const tokenContract = new ethers.Contract(fromTokenData.address, erc20Abi, signer);
          const allowance = await tokenContract.allowance(currentAccount, routerAddress);
          if (allowance.lt(amountInWei)) {
            // Approve the router to spend the token (for the exact amount)
            const approveTx = await tokenContract.approve(routerAddress, amountInWei);
            await approveTx.wait();
          }
        }
        // Call appropriate router function
        if (isETHtoDRT) {
          // Swap ETH to DRT (send ETH value)
          tx = await routerContract.swapETHforDRT(0, { value: amountInWei });
        } else if (isDRTtoETH) {
          // Swap DRT to ETH
          tx = await routerContract.swapDRTforETH(amountInWei, 0);
        } else {
          // Swap any ERC-20 to any ERC-20 (including DRT to others or others to DRT)
          tx = await routerContract.swapExactTokensForTokens(amountInWei, 0, fromTokenData.address, toTokenData.address);
        }
        const receipt = await tx.wait();
        if (receipt && receipt.status === 1) {
          // Successful transaction
          errorDiv.style.color = "green";
          errorDiv.textContent = "Swap successful!";
          // Update impact points in localStorage
          const pointsKey = "impactPoints_" + currentAccount.toLowerCase();
          const prevPoints = parseInt(localStorage.getItem(pointsKey) || "0");
          const newPoints = prevPoints + 1;
          localStorage.setItem(pointsKey, newPoints);
          document.getElementById("impactPointsDisplay").textContent = "Impact Points: " + newPoints;
        } else {
          errorDiv.textContent = "Swap transaction failed (reverted).";
        }
      } catch (err) {
        console.error("Swap error:", err);
        if (err.code === 4001) {
          // Ethers error code 4001 = user rejected request (either approve or swap)
          errorDiv.textContent = "Swap cancelled by user.";
        } else {
          errorDiv.textContent = "Swap failed: " + (err.message || err);
        }
      } finally {
        swapButton.disabled = false;
        swapButton.textContent = "Swap";
      }
    });

    // On page load: initialize provider, load tokens & ABI, populate selects
    window.addEventListener("load", async () => {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
      }
      // Fetch token list and contract ABI from external files
      try {
        const tokenRes = await fetch("tokenRegistry.json");
        tokens = await tokenRes.json();
      } catch (e) {
        console.error("Could not load token registry:", e);
      }
      try {
        const abiRes = await fetch("abi/DRTUniversalRouter_abi.json");
        routerAbi = await abiRes.json();
      } catch (e) {
        console.error("Could not load router ABI:", e);
      }
      // Add ETH to tokens list if not present, for convenience in dropdowns
      if (!tokens.find(t => t.symbol === "ETH")) {
        tokens.unshift({ symbol: "ETH", address: null, decimals: 18 });
      }
      populateTokenSelects();
      // If user already connected (e.g., site previously authorized), set up signer and contract
      if (window.ethereum) {
        const accounts = await provider.listAccounts();
        if (accounts.length > 0) {
          currentAccount = accounts[0];
          signer = provider.getSigner();
          walletAddressSpan.textContent = shortenAddress(currentAccount);
          if (routerAbi) {
            routerContract = new ethers.Contract(routerAddress, routerAbi, signer);
          }
          // Show existing impact points for this account
          const pointsKey = "impactPoints_" + currentAccount.toLowerCase();
          const storedPoints = parseInt(localStorage.getItem(pointsKey) || "0");
          document.getElementById("impactPointsDisplay").textContent = "Impact Points: " + storedPoints;
        }
        // Listen for account changes to update UI
        window.ethereum.on("accountsChanged", accounts => {
          if (accounts.length === 0) {
            // No accounts (wallet disconnected)
            currentAccount = null;
            signer = null;
            routerContract = null;
            walletAddressSpan.textContent = "";
            document.getElementById("impactPointsDisplay").textContent = "Impact Points: 0";
          } else {
            // Use first account from array
            currentAccount = accounts[0];
            signer = provider.getSigner();
            walletAddressSpan.textContent = shortenAddress(currentAccount);
            if (routerAbi) {
              routerContract = new ethers.Contract(routerAddress, routerAbi, signer);
            }
            // Update displayed points for new account
            const pointsKey = "impactPoints_" + currentAccount.toLowerCase();
            const storedPoints = parseInt(localStorage.getItem(pointsKey) || "0");
            document.getElementById("impactPointsDisplay").textContent = "Impact Points: " + storedPoints;
          }
        });
      }
    });
  </script>
</body>
</html>
